syntax = "proto3";

package rust_guest;
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

message LogResolveRequest {
  string resolve_id = 1;
  google.protobuf.Struct evaluation_context = 2;
  repeated ResolvedValue value = 3;
  Client client = 4;
  optional Sdk sdk = 5;
}

message LogAssignRequest {
  string resolve_id = 1;
  google.protobuf.Struct evaluation_context = 2;
  google.protobuf.Timestamp skew_adjusted_applied_time = 3;
  AssignedFlag assigned_flag = 4;
  optional Sdk sdk = 5;
  Client client = 6;
}

message Sdk {
  oneof sdk {
    // Name of a Confidence SDKs.
    SdkId id = 1;
    // Custom name for non-Confidence SDKs.
    string custom_id = 2;
  }

  // Version of the SDK.
  string version = 3;
}

enum SdkId {
  SDK_ID_RUST_PROVIDER = 0;
}

message ResolvedValue {
  Flag flag = 1;
  optional AssigmentMatch assignment_match = 2;
  repeated FallthroughRule fallthrough_rules = 3;
}

message AssigmentMatch {
  string assignment_id = 1;
  optional Variant variant = 2;
  optional MatchedRule matched_rule = 3;
}

message Variant {
  string name = 1;
}

message MatchedRule {
  string name = 1;
}

message FallthroughRule {
  string targeting_key = 1;
  string targeting_key_selector = 2;
  string assignment_id = 3;
  string name = 4;
}

message Flag {
  string name = 1;
}

message AssignedFlag {
  string flag = 1;

  string targeting_key = 2;
  string targeting_key_selector = 10;

  string segment = 3;

  string variant = 4;

  string rule = 5;

  ResolveReason reason = 6;

  repeated FallthroughAssignment fallthrough_assignments = 9;

  string assignment_id = 8;
}

enum ResolveReason {
  // Unspecified enum.
  RESOLVE_REASON_UNSPECIFIED = 0;
  // The flag was successfully resolved because one rule matched.
  RESOLVE_REASON_MATCH = 1;
  // The flag could not be resolved because no rule matched.
  RESOLVE_REASON_NO_SEGMENT_MATCH = 2;
  // The flag could not be resolved because the matching rule had no variant
  // that could be assigned.
  RESOLVE_REASON_NO_TREATMENT_MATCH = 3 [deprecated = true];
  // The flag could not be resolved because it was archived.
  RESOLVE_REASON_FLAG_ARCHIVED = 4;
  // The flag could not be resolved because the targeting key field was invalid
  RESOLVE_REASON_TARGETING_KEY_ERROR = 5;
  // Unknown error occurred during the resolve
  RESOLVE_REASON_ERROR = 6;
}

message Client {
  Account account = 1;
  string client_name = 2;
  string client_credential_name = 3;
}

message Account {
  string name = 1;
}

message FallthroughAssignment {
  string rule = 1;

  string assignment_id = 2;

  string targeting_key = 3;
  string targeting_key_selector = 4;
}